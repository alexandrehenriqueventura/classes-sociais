/* JS reutilizado/adaptado do projeto ODS 1 */
'use strict';
class App{constructor(){document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>this.init()):this.init()}init(){this.mobile();this.smooth();this.theme();this.top();this.progress();this.search();this.registerSW()}mobile(){const b=document.querySelector('.mobile-menu'),n=document.querySelector('.nav-links');if(!b||!n)return;b.addEventListener('click',()=>{n.classList.toggle('active');b.setAttribute('aria-expanded',n.classList.contains('active'));document.body.style.overflow=n.classList.contains('active')?'hidden':''});document.addEventListener('click',e=>{if(!b.contains(e.target)&&!n.contains(e.target)){n.classList.remove('active');b.setAttribute('aria-expanded','false');document.body.style.overflow=''}})}smooth(){document.querySelectorAll('a[href^="#"]').forEach(a=>a.addEventListener('click',e=>{const id=a.getAttribute('href');if(id==='#')return;e.preventDefault();const el=document.querySelector(id);if(el){const top=(document.querySelector('nav')?.offsetHeight||80);window.scrollTo({top:el.offsetTop-top-10,behavior:'smooth'});document.querySelector('.nav-links')?.classList.remove('active')}}))}theme(){const t=document.querySelector('.theme-toggle');const prefers=matchMedia('(prefers-color-scheme: dark)');const saved=localStorage.getItem('theme');const current=saved|| (prefers.matches?'dark':'light');document.documentElement.setAttribute('data-theme',current);t&&(t.innerHTML=current==='dark'?'<i class="fas fa-sun"></i> Claro':'<i class="fas fa-moon"></i> Escuro',t.addEventListener('click',()=>{const cur=document.documentElement.getAttribute('data-theme');const next=cur==='dark'?'light':'dark';document.documentElement.setAttribute('data-theme',next);localStorage.setItem('theme',next)}))}top(){const b=document.querySelector('.back-to-top');if(!b)return;addEventListener('scroll',()=>{b.classList.toggle('visible',pageYOffset>innerHeight)});b.addEventListener('click',()=>scrollTo({top:0,behavior:'smooth'}))}progress(){const p=document.querySelector('.reading-progress');if(!p)return;addEventListener('scroll',()=>{const h=document.documentElement.scrollHeight-innerHeight;p.style.width=Math.min((pageYOffset/h)*100,100)+'%'});}search(){const i=document.querySelector('#search-input'),r=document.querySelector('.search-results');if(!i||!r)return;const idx=[...document.querySelectorAll('section[id]')].map(s=>({id:s.id,title:(s.querySelector('h2,h3,h4')?.textContent||'').trim(),content:s.textContent.toLowerCase()}));let to;i.addEventListener('input',e=>{clearTimeout(to);const q=e.target.value.trim().toLowerCase();to=setTimeout(()=>{if(q.length<2){r.style.display='none';return}const res=idx.filter(it=>it.title.toLowerCase().includes(q)||it.content.includes(q)).slice(0,6);r.innerHTML=res.length?res.map(x=>`<div class="search-result-item" data-target="#${x.id}" tabindex="0"><strong>${x.title}</strong></div>`).join(''):'<div class="search-no-results">Nenhum resultado</div>';r.style.display='block';r.querySelectorAll('.search-result-item').forEach(el=>{el.addEventListener('click',()=>{document.querySelector(el.dataset.target)?.scrollIntoView({behavior:'smooth'});r.style.display='none'});el.addEventListener('keydown',ev=>{if(ev.key==='Enter'){document.querySelector(el.dataset.target)?.scrollIntoView({behavior:'smooth'});r.style.display='none'}})})},250)})}registerSW(){'serviceWorker'in navigator&&addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}))}};new App();